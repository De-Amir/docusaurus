---
title: OPQ Makai
sidebar_label: Makai
---

OPQ Makai is a set of destributed services which together are responsible for aggregating and processing the measurements generated by the OPQBoxes. OPQ Makai is made up of three software components, each responsible for a specific task in the OPQ ecosystem. These components are:

* Triggering Broker.
* Acquisition Broker.
* Triggering Service.

Makai system uses [0MQ](http://zeromq.org/) for transport and [protobuf](https://developers.google.com/protocol-buffers/) for serialization. This allows easy integration with heterogenious and polylingual systems, such as OPQ Mauka and OPQ View.The block diagram of Makai components is shown bellow:

<img src="/docs/assets/makai/makai_main.svg">

## Triggering Broker

Triggering broker is used as an endpoint for the feature reduced data generated by the OPQBox devices. Furthermore, it serves as a endpoint for the rest of the OPQ infrastructure for receiving OPQBox triggering stream. It receives frequency, Vrms and THD measurements from the OPQBox and forwards them to the connected clients. Every client is authenticated using the 0MQ security suite CurveMQ. In order to do that, a public key of every OPQBox must be provided to the TriggeringBroker at startup. Furthermore in order to authenticate the TriggeringBroker it's public key is distributed to every OPQBox. Triggeringbroker uses a SUB socket pair for receiving data from the box and a PUB socket from forwarding data further down the line. 

### Configuration
By default triggering broker will look for it's configuration file in `/etc/opq/triggering_broker.json` A default configuration file is shown below:

```
{
  "client_certs": "/etc/opq/curve/public_keys",
  "server_cert": "/etc/opq/curve/private_keys/opqserver_secret",
  "interface": "tcp://*:9880",
  "backend" : "tcp://*:9881"
}
```

Fields are as follows:
* *client_cert* : directory containing public keys of the OPQBoxes.
* *server_cert* : private key of the Triggering Broker.
* *interface* : endpoint for the OPQBox.
* *backend* : endpoint for the cloud infrastructure

### Interface

In order to communicate with the triggering broker, connect to backend port with using ZMQ SUB socket with a language of your choice and subscribe to OPQBox2 IDs you would like to receive data from. Alternatively and empty subscription will receive data from all devices. Each message contains two frames. The first frame is the box id encoded as a string. The second frame contains a protobuf encoded TriggerMessage described in the [Protocol](/docs/protocol.html) section.

## Acquisition Broker

Acquisition Broker is a microservice responsible for raw waveform acquisition from the OPQBoxes. Similarly to the triggering broker, all communication between OPQBox and acquisition broker is authenticated and encrypted using the CurveMQ. The diagram of the acquisiton broker interfaces is shown below:

<img src="/docs/assets/makai/acq_brk.png">

OPQBoxes connect to the acquisition broker's PUB interface and wait for a raw data requests. Once a raw data request arives it is forwarded to the acquisition broker via the PULL interface. Raw waveform data as well as the event request are logged in the MongoDB. For Mongodb schema data model examine the [Data Model](/docs/datamodel.html) section.

### Configuration
By default acquisition broker will attempt to load a configuration file located in `/etc/opq/acquisition_broker_config.json`. Alternatively a configuration file can be passed as a command line argument.

```
{
  "client_certs": "/etc/opq/curve/public_keys",
  "server_cert": "/etc/opq/curve/private_keys/opqserver_secret",
  "box_pub": "tcp://*:8194",
  "box_pull": "tcp://*:8196",
  "backend_pull": "tcp://*:9884",
  "backend_pub": "tcp://*:9882",
  "mongo_uri": "mongodb://localhost:27017"
}
```

The fields are as follows:
* *client_certs* : path to directory containing OPQBox public keys.
* *server_cert* : path to the server private key.
* *box_pub* : a PUB interface for OPQBox.
* *box_pull* : a PULL interface for the OPQBox.
* *backend_pull* : an OPQHub PULL endpoint.
* *backend_pub* : an OPQHub PUB endpoint.
* *mongo_uri* : mongo host and port.

### Interface:

In oder to initiate an event acquisition a client connects to the Acquisition broker's PULL interface and send it a protobuf encoded [ReqtestDataMessage](/docs/protocol.html). Furthermore any client connected to the PUB interface will be notified of a new event by receiving a text encoded event number.

## Acquisition Service

Acquisition service is responsible for analysing the triggering streams from the OPQBoxes and requesting raw waveforms whenever an anomaly is detected. 
